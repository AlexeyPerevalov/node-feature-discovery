# Build node feature discovery
FROM golang:1.13.12 as builder

# Get (cache) deps in a separate layer
COPY go.mod go.sum /go/node-feature-discovery/
COPY Certificates /usr/local/share/ca-certificates/Certificates/
RUN chmod 755 /usr/local/share/ca-certificates/Certificates
RUN chmod 644 /usr/local/share/ca-certificates/Certificates/* 
RUN update-ca-certificates

WORKDIR /go/node-feature-discovery


ARG HTTPS_PROXY
ARG HTTP_PROXY
ENV GOPROXY http://cmc-cd-mirror.rnd.huawei.com/goproxy/
ENV https_proxy $HTTPS_PROXY
ENV http_proxy $HTTP_PROXY

RUN go mod download

# Do actual build
COPY . /go/node-feature-discovery

ARG NFD_VERSION
ARG HOSTMOUNT_PREFIX

RUN go install \
  -ldflags "-s -w -X sigs.k8s.io/node-feature-discovery/pkg/version.version=$NFD_VERSION -X sigs.k8s.io/node-feature-discovery/source.pathPrefix=$HOSTMOUNT_PREFIX" \
  ./cmd/*
RUN install -D -m644 nfd-worker.conf.example /etc/kubernetes/node-feature-discovery/nfd-worker.conf

RUN make test


# Create production image for running node feature discovery
FROM debian:stretch-slim

# Use more verbose logging of gRPC
ENV GRPC_GO_LOG_SEVERITY_LEVEL="INFO"

COPY --from=builder /etc/kubernetes/node-feature-discovery /etc/kubernetes/node-feature-discovery
COPY --from=builder /go/bin/nfd-* /usr/bin/
